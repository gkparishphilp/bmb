- content_for :left_column do
	%h1 
		Purchase
		= @sku.title
	#price_div( style="width:150px;" )
		%h3
			Price: 
			%span#the_price( sku_price="#{@sku.price}" )
				= number_to_currency @sku.price.to_f / 100
	#checkout
		-if @order.paypal_express_token.blank?	

			-form_for @order do |f|
	
				%table
					= f.hidden_field :price, :value => @sku.price
					= f.hidden_field :sku_id, :value => @sku.id
					%tr
						%td &nbsp;
						%td &nbsp;
					%tr
						%td
							%h3 Payment Information
							(Only US Credit Cards Accepted)
					%tr
						%td
							%b Payment Method
						%td#pay_select
							=f.radio_button :payment_type, "credit_card", :id => "credit_radio", :checked => true
							= image_tag 'card_images/ccards_all.png', :id => 'card_images', :align => 'center', :alt => 'Credit Card'
							&nbsp &nbsp &nbsp
							-unless @sku.sku_type == 'subscription'
								=f.radio_button :payment_type, "paypal", :id => 'paypal_radio'
								<!-- PayPal Logo --><a href="#" onclick="javascript:window.open('https://www.paypal.com/cgi-bin/webscr?cmd=xpt/Marketing/popup/OLCWhatIsPayPal-outside','olcwhatispaypal','toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=400, height=350');"><img  src="https://www.paypal.com/en_US/i/logo/PayPal_mark_37x23.gif" border="0" alt="Acceptance Mark" align="center"></a><!-- PayPal Logo -->
				%br
				%br
				#cc_info
					%table
						%tr
							%td
								%b E-mail
							- @order.email = @current_user.email unless @current_user.anonymous?
							%td= f.text_field :email

						-if @sku.sku_type != 'subscription'
							%tr
								%td
									%b Enter Coupon Code
								%td
									=text_field_tag :coupon_code
									#valid_coupon_div( style = "margin:10px 0px;")
										#valid_coupon
						%tr
							%td
								%b Card Number
							- @order.card_number = '4411037113154626' if Rails.env.development?
							%td= f.text_field :card_number

						%tr
							%td
								%b Card Security Code (CVV)
								-  @order.card_cvv = '123' if Rails.env.development?
							%td
								= f.text_field :card_cvv
								&nbsp;&nbsp;
								= image_tag 'card_images/cvv.png', :align => 'center'
						%tr
							%td 
								%b Card Expiration
								- @order.card_exp_year = '2013' if Rails.env.development?
							%td
								= f.select :card_exp_month, @months
								&nbsp;/&nbsp;
								= f.select :card_exp_year, @years
					%br
					%br

					- if @current_user.billing_addresses.empty? 
						= fields_for :billing_address, @order.billing_address do |bb|

							=bb.hidden_field :country, :value => 'US'
							%table
								%tr
									%td 
									%td 
										%h3 Billing Info
								%tr
									%td
										%b First Name:
									%td= bb.text_field :first_name

								%tr
									%td
										%b Last Name:
									%td= bb.text_field :last_name
								%tr
									%td
										%b Address:
									%td= bb.text_field :street

								%tr
									%td
										%b City:
									%td=bb.text_field :city

								%tr
									%td
										%b State:
									%td
										= bb.collection_select :geo_state_id, @states, :id, :name
										&nbsp;&nbsp;
										%b Zip Code:
										=bb.text_field :zip, :size => 10

					-else
						Select a billing address
			
						= f.collection_select :billing_address_id, @current_user.billing_addresses, :id , :street

						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						Or check to enter a new billing address
						= check_box_tag "use_new_billing_address", "use_new_billing_address"
						%br
						%br
						= fields_for :billing_address, @order.billing_address do |bb|

							=bb.hidden_field :country, :value => 'US'
							%table#new_billing_address
								%tr
									%td 
									%td 
										%h3 Billing Info
								%tr
									%td
										%b First Name:
									%td= bb.text_field :first_name

								%tr
									%td
										%b Last Name:
									%td= bb.text_field :last_name
								%tr
									%td
										%b Address:
									%td= bb.text_field :street

								%tr
									%td
										%b City:
									%td=bb.text_field :city

								%tr
									%td
										%b State:
									%td
										= bb.collection_select :geo_state_id, @states, :id, :name
										&nbsp;&nbsp;
										%b Zip Code:
										=bb.text_field :zip, :size => 10
		
					%br
					- if @sku.contains_merch?
						- if @current_user.shipping_addresses.empty?
							= fields_for :shipping_address, @order.shipping_address do |ff|

								=ff.hidden_field :country, :value => 'US'
								%table
									%tr
										%td
										%td 
											%h3 Shipping Information
									%tr
										%td

									%tr
										%td
											%b First Name:
										%td= ff.text_field :first_name

									%tr
										%td
											%b Last Name:
										%td= ff.text_field :last_name


									%tr
										%td
											%b Address:
										%td= ff.text_field :street

									%tr
										%td
											%b City:
										%td= ff.text_field :city

									%tr
										%td
											%b State:
										%td
											= ff.collection_select :geo_state_id, @states, :id, :name
											&nbsp;&nbsp;
											%b Zip Code:
											= ff.text_field :zip, :size => 10
		
						-else
							Select a shipping address:
							= f.collection_select :shipping_address_id, @current_user.shipping_addresses, :id , :street
							
							&nbsp;&nbsp;&nbsp;
							Or check to enter a new shipping address
							= check_box_tag "use_new_shipping_address", "use_new_shipping_address"
							%br
							%br
							= fields_for :shipping_address, @order.shipping_address do |ff|

								=ff.hidden_field :country, :value => 'US'
								%table#new_shipping_address

									%tr
										%td
										%td 
											%h3 Shipping Information
									%tr
										%td

									%tr
										%td
											%b First Name:
										%td= ff.text_field :first_name

									%tr
										%td
											%b Last Name:
										%td= ff.text_field :last_name

									%tr
										%td
											%b Address:
										%td= ff.text_field :street

									%tr
										%td
											%b City:
										%td= ff.text_field :city

									%tr
										%td
											%b State:
										%td
											= ff.collection_select :geo_state_id, @states, :id, :name
											&nbsp;&nbsp;
											%b Zip Code:
											= ff.text_field :zip, :size => 10
		
					%br
					%br
					= f.submit "Buy"
			
			#paypal_x_checkout
				Click the PayPal logo below to sign into your PayPal account.  You will be returned here to complete your order.
				%br
				%br
				= link_to image_tag( 'https://www.paypal.com/en_US/i/btn/btn_xpressCheckout.gif' ), paypal_express_new_order_path(:sku => @sku)
			
		-else
			-form_for @order do |f|
				= f.hidden_field :paypal_express_token, :value => @order.paypal_express_token
				= f.hidden_field :paypal_express_payer_id, :value => @order.paypal_express_payer_id
				= f.hidden_field :user_id, :value => @current_user.id
				= f.hidden_field :price, :value => @sku.price
				= f.hidden_field :sku_id, :value => @sku.id
				- if @current_user.anonymous?
					%b E-mail (REQUIRED)
					= f.text_field :email
				-else
					= f.hidden_field :email, :value => @current_user.email
				%br
				%b Enter Coupon Code (if applicable)
				= text_field_tag :coupon_code
				%br
				Please confirm your Paypal order by clicking the button below.
				%br
				%br
				= f.submit "Confirm Your Paypal Order", :class => :button
